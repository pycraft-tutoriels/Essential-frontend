<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essential - Simplifie tes conversations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            color: #4c1d95;
            max-width: 90%;
            width: 400px;
        }
        .message-box button {
            background-color: #facc15;
            color: #4c1d95; 
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; 
            margin-top: 1rem;
            transition: all 0.3s ease-in-out;
        }
        .message-box button:hover {
            background-color: #fde047; 
            transform: scale(1.05);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center p-4 font-sans text-white">

        <div id="landing-page" class="bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl w-full max-w-lg p-8 text-center border border-white border-opacity-20 transform transition-all duration-300 hover:scale-105">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-4 leading-tight">
                Bienvenue sur <span class="text-yellow-300">Essential</span> !
            </h1>
            <p class="text-lg md:text-xl mb-8 opacity-90">
                Simplifie tes conversations, concentre-toi sur l'essentiel.
            </p>

            <div class="space-y-6 mb-10">
                <div class="flex items-center justify-center bg-white bg-opacity-15 rounded-xl p-4 shadow-inner">
                    <span class="text-4xl mr-4">⏳</span>
                    <p class="text-lg font-semibold text-left">
                        Crée des groupes qui disparaissent après l'événement.
                        <br>
                        <span class="text-sm opacity-80">Fini le désordre !</span>
                    </p>
                </div>

                <div class="flex items-center justify-center bg-white bg-opacity-15 rounded-xl p-4 shadow-inner">
                    <span class="text-4xl mr-4">⭐</span>
                    <p class="text-lg font-semibold text-left">
                        Marque les messages importants pour ne rien manquer.
                        <br>
                        <span class="text-sm opacity-80">L'essentiel en un clin d'œil.</span>
                    </p>
                </div>
            </div>

            <button
                id="start-adventure-button"
                class="bg-yellow-400 text-purple-800 font-bold py-4 px-8 rounded-full text-xl shadow-lg hover:bg-yellow-300 transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-yellow-300 focus:ring-opacity-75"
            >
                Commencer l'aventure !
            </button>

            <p class="mt-8 text-sm opacity-70">
                Une communication plus claire, plus simple, plus toi.
            </p>
        </div>

        <div id="auth-page" class="hidden bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl w-full max-w-md p-8 text-center border border-white border-opacity-20 transform transition-all duration-300 hover:scale-105">
            <h1 id="auth-title" class="text-4xl md:text-5xl font-extrabold mb-6 leading-tight">
                Connexion
            </h1>

            <div id="auth-message" class="hidden mb-4"></div>

            <form id="auth-form" class="space-y-6">
                <input
                    type="email"
                    id="email-input"
                    placeholder="Adresse Email"
                    class="w-full p-4 rounded-xl bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-yellow-300 transition duration-200"
                    required
                />

                <input
                    type="password"
                    id="password-input"
                    placeholder="Mot de passe"
                    class="w-full p-4 rounded-xl bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-yellow-300 transition duration-200"
                    required
                />

                <button
                    type="submit"
                    id="submit-button"
                    class="w-full bg-yellow-400 text-purple-800 font-bold py-4 px-8 rounded-full text-xl shadow-lg hover:bg-yellow-300 transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-yellow-300 focus:ring-opacity-75"
                >
                    Se connecter
                </button>
            </form>

            <p class="mt-8 text-md opacity-80">
                <span id="toggle-text">Pas encore de compte ?</span>
                <button
                    id="toggle-button"
                    class="ml-2 font-bold text-yellow-300 hover:text-yellow-200 transition duration-200 focus:outline-none"
                >
                    S'inscrire
                </button>
            </p>
        </div>

        <div id="home-page" class="hidden bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl w-full max-w-md flex flex-col h-[90vh] overflow-hidden border border-white border-opacity-20">
            <div class="bg-white bg-opacity-15 p-4 rounded-t-3xl shadow-md flex justify-between items-center">
                <h1 class="text-2xl font-bold text-white">Essential</h1>
                <button id="add-new-conversation-button" class="bg-yellow-400 text-purple-800 p-2 rounded-full shadow-md hover:bg-yellow-300 transition-all duration-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
            </div>

            <div class="flex bg-white bg-opacity-15 p-2 mx-4 mt-4 rounded-xl shadow-inner">
                <button
                    id="chats-tab-button"
                    class="flex-1 py-2 text-center rounded-lg font-semibold transition-colors duration-200"
                >
                    Chats
                </button>
                <button
                    id="groups-tab-button"
                    class="flex-1 py-2 text-center rounded-lg font-semibold transition-colors duration-200"
                >
                    Groupes
                </button>
            </div>

            <div class="p-4">
                <input
                    type="text"
                    placeholder="Rechercher..."
                    class="w-full p-3 rounded-xl bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-yellow-300 transition duration-200"
                />
            </div>

            <div id="conversation-list" class="flex-1 overflow-y-auto p-4 space-y-3">
            </div>
        </div>

        <div id="chat-page" class="hidden bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl w-full max-w-md flex flex-col h-[90vh] overflow-hidden border border-white border-opacity-20">
            <div class="bg-white bg-opacity-15 p-4 rounded-t-3xl shadow-md flex justify-between items-center">
                <button id="back-to-home-button" class="text-white text-opacity-80 hover:text-white transition-colors duration-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 id="chat-contact-name" class="text-2xl font-bold text-white"></h1> <button class="text-white text-opacity-80 hover:text-white transition-colors duration-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                    </svg>
                </button>
            </div>

            <div id="messages-display-area" class="flex-1 p-4 overflow-y-auto space-y-3 bg-white bg-opacity-5">
                </div>
            <div id="messages-end-ref"></div> <form id="message-input-form" class="p-4 bg-white bg-opacity-15 border-t border-white border-opacity-20 flex items-center space-x-3">
                <input
                    type="text"
                    id="new-message-input"
                    placeholder="Écrivez votre message..."
                    class="flex-1 p-3 border border-white border-opacity-30 rounded-lg bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-yellow-300 transition duration-200"
                />
                <button
                    type="button"
                    id="priority-toggle-button"
                    class="p-3 rounded-lg transition-all duration-200 ease-in-out bg-white bg-opacity-20 text-white text-opacity-70 hover:bg-opacity-30"
                    title="Marquer comme prioritaire"
                >
                    ⭐
                </button>
                <button
                    type="submit"
                    id="send-message-button"
                    class="bg-yellow-400 text-purple-800 p-3 rounded-lg shadow-md hover:bg-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-300 transition duration-200"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
            </form>
        </div>
        <div id="new-conversation-page" class="hidden min-h-screen bg-gradient-to-br from-purple-800 to-indigo-900 text-white flex flex-col p-6">
            <div class="flex items-center justify-between mb-8">
                <button id="back-from-new-conversation-button" class="text-white text-3xl p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors duration-200">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-center flex-grow">Nouvelle Conversation</h2>
                <div class="w-8"></div> </div>
            
            <div class="flex mb-6 bg-purple-700 rounded-xl shadow-lg p-2">
                <button id="new-chat-tab-button" class="flex-1 py-3 px-4 rounded-lg font-semibold text-lg transition-all duration-200 ease-in-out">
                        Nouveau Chat
                </button>
                <button id="new-group-tab-button" class="flex-1 py-3 px-4 rounded-lg font-semibold text-lg transition-all duration-200 ease-in-out">
                    Nouveau Groupe
                </button>
            </div>
            
            <form id="create-chat-form" class="flex flex-col space-y-6">
                <input type="text" id="chat-contact-name-input" placeholder="Nom du contact (ex: Alice)" class="p-4 rounded-xl bg-white bg-opacity-10 border border-purple-600 text-white placeholder-white placeholder-opacity-70 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition-all duration-200">
                <input type="email" id="chat-contact-identifier-input" placeholder="Email du contact (ex: alice@exemple.com)" class="p-4 rounded-xl bg-white bg-opacity-10 border border-purple-600 text-white placeholder-white placeholder-opacity-70 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition-all duration-200">
                <button type="submit" class="bg-yellow-400 text-purple-800 font-bold py-4 rounded-xl shadow-lg hover:bg-yellow-300 transition-colors duration-200 text-xl">
                    Créer le Chat
                </button>
            </form>
            
            <form id="create-group-form" class="hidden flex-col space-y-6">
                <input type="text" id="group-name-input" placeholder="Nom du groupe (ex: Projet Essential)" class="p-4 rounded-xl bg-white bg-opacity-10 border border-purple-600 text-white placeholder-white placeholder-opacity-70 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition-all duration-200">
                <input type="text" id="group-members-input" placeholder="Emails des membres (séparés par des virgules)" class="p-4 rounded-xl bg-white bg-opacity-10 border border-purple-600 text-white placeholder-white placeholder-opacity-70 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition-all duration-200">
                <input type="date" id="group-end-date-input" class="p-4 rounded-xl bg-white bg-opacity-10 border border-purple-600 text-white placeholder-white placeholder-opacity-70 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition-all duration-200">
                <button type="submit" class="bg-yellow-400 text-purple-800 font-bold py-4 rounded-xl shadow-lg hover:bg-yellow-300 transition-colors duration-200 text-xl">
                    Créer le Groupe
                </button>
            </form>
        </div>
        </div>
    </div>

    <div id="message-box-container"></div>

    <script>
        const backendUrl = 'https://essential-app-seven.vercel.app';

        const loginEmailInput = document.getElementById('login-email-input');
        const loginPasswordInput = document.getElementById('login-password-input');
        const loginForm = document.getElementById('login-form');
        const registerEmailInput = document.getElementById('register-email-input');
        const registerPasswordInput = document.getElementById('register-password-input');
        const registerForm = document.getElementById('register-form');
        
        const authPage = document.getElementById('auth-page');
        const homePage = document.getElementById('home-page');
        const newConversationPage = document.getElementById('new-conversation-page');
        const chatPage = document.getElementById('chat-page');
        
        const loginTabButton = document.getElementById('login-tab-button');
        const getStartedButton = document.getElementById('get-started-button');
        const registerTabButton = document.getElementById('register-tab-button');
        
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageCloseButton = document.getElementById('message-close-button');
        
        const showNewConversationButton = document.getElementById('show-new-conversation-button');
        const backFromNewConversationButton = document.getElementById('back-from-new-conversation-button');
        const backFromChatButton = document.getElementById('back-from-chat-button');
        
        const conversationsList = document.getElementById('conversations-list');
        const chatHeaderName = document.getElementById('chat-header-name');
        const chatMessages = document.getElementById('chat-messages');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        
        const chatContactNameInput = document.getElementById('chat-contact-name-input');
        const chatContactIdentifierInput = document.getElementById('chat-contact-identifier-input');
        const createChatForm = document.getElementById('create-chat-form');
        
        const newChatTabButton = document.getElementById('new-chat-tab-button');
        const newGroupTabButton = document.getElementById('new-group-tab-button');
        const createGroupForm = document.getElementById('create-group-form');
        const groupNameInput = document.getElementById('group-name-input');
        const groupMembersInput = document.getElementById('group-members-input');
        const groupEndDateInput = document.getElementById('group-end-date-input');
        
        const chatInfoButton = document.getElementById('chat-info-button');
        const chatInfoModal = document.getElementById('chat-info-modal');
        const chatInfoCloseButton = document.getElementById('chat-info-close-button');
        const chatInfoName = document.getElementById('chat-info-name');
        const chatInfoIsGroup = document.getElementById('chat-info-is-group');
        const chatInfoParticipants = document.getElementById('chat-info-participants');
        const chatInfoEndDate = document.getElementById('chat-info-end-date');
        const chatInfoTimer = document.getElementById('chat-info-timer');
        
        let currentChatId = null;
        let currentChatData = null;
        let starredConversations = new Set();
        
        window.currentUserData = null;
        
        function navigateTo(page) {
            authPage.classList.add('hidden');
            homePage.classList.add('hidden');
            newConversationPage.classList.add('hidden');
            chatPage.classList.add('hidden');
        
            if (page === 'auth') {
                authPage.classList.remove('hidden');
            } else if (page === 'home') {
                homePage.classList.remove('hidden');
                updateHomeUI();
            } else if (page === 'new-conversation') {
                newConversationPage.classList.remove('hidden');
                newChatTabButton.click();
            } else if (page === 'chat') {
                chatPage.classList.remove('hidden');
            }
        }
        
        function showMessageBox(message, type = 'info') {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-blue-500');
            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }
        
        loginTabButton.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            loginTabButton.classList.add('bg-purple-600');
            registerTabButton.classList.remove('bg-purple-600');
        });
        
        registerTabButton.addEventListener('click', () => {
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            registerTabButton.classList.add('bg-purple-600');
            loginTabButton.classList.remove('bg-purple-600');
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
        
            try {
                const response = await fetch(`${backendUrl}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });
                const result = await response.json();
                if (response.ok) {
                    showMessageBox(result.message, 'success');
                    const userDataResponse = await fetch(`${backendUrl}/user/${encodeURIComponent(email)}`);
                    if (userDataResponse.ok) {
                        window.currentUserData = await userDataResponse.json();
                        starredConversations = new Set(window.currentUserData.conversations.filter(c => c.isPriority).map(c => c.id));
                        navigateTo('home');
                    } else {
                        showMessageBox("Erreur lors de la récupération des données utilisateur.", "error");
                        navigateTo('auth');
                    }
                } else {
                    showMessageBox(result.error, 'error');
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                showMessageBox('Connexion impossible. Erreur réseau.', 'error');
            }
        });
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
        
            try {
                const response = await fetch(`${backendUrl}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });
                const result = await response.json();
                if (response.ok) {
                    showMessageBox(result.message, 'success');
                    loginTabButton.click();
                    registerEmailInput.value = '';
                    registerPasswordInput.value = '';
                } else {
                    showMessageBox(result.error, 'error');
                }
            } catch (error) {
                console.error('Erreur d\'inscription:', error);
                showMessageBox('Inscription impossible. Erreur réseau.', 'error');
            }
        });
        
        messageCloseButton.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });
        
        showNewConversationButton.addEventListener('click', () => {
            navigateTo('new-conversation');
        });
        
        backFromNewConversationButton.addEventListener('click', () => {
            navigateTo('home');
        });
        
        backFromChatButton.addEventListener('click', () => {
            currentChatId = null;
            currentChatData = null;
            navigateTo('home');
        });
        
        newChatTabButton.addEventListener('click', () => {
            newChatTabButton.classList.add('bg-purple-600');
            newGroupTabButton.classList.remove('bg-purple-600');
            createChatForm.classList.remove('hidden');
            createGroupForm.classList.add('hidden');
        });
        
        newGroupTabButton.addEventListener('click', () => {
            newGroupTabButton.classList.add('bg-purple-600');
            newChatTabButton.classList.remove('bg-purple-600');
            createGroupForm.classList.remove('hidden');
            createChatForm.classList.add('hidden');
        });
        
        function updateHomeUI() {
            conversationsList.innerHTML = '';
        
            if (!window.currentUserData || !window.currentUserData.conversations) {
                conversationsList.innerHTML = '<p class="text-white text-center opacity-70">Aucune conversation.</p>';
                return;
            }
        
            const priorityConversations = window.currentUserData.conversations.filter(c => starredConversations.has(c.id));
            const regularConversations = window.currentUserData.conversations.filter(c => !starredConversations.has(c.id));
        
            [...priorityConversations, ...regularConversations].forEach(conv => {
                const conversationItem = document.createElement('div');
                conversationItem.classList.add('bg-purple-700', 'p-4', 'rounded-xl', 'flex', 'items-center', 'space-x-4', 'mb-3', 'shadow-md', 'hover:bg-purple-600', 'transition-colors', 'duration-200');
                conversationItem.dataset.chatId = conv.id;
        
                const icon = document.createElement('div');
                icon.classList.add('flex-shrink-0', 'w-12', 'h-12', 'rounded-full', 'bg-yellow-400', 'flex', 'items-center', 'justify-center', 'text-purple-900', 'font-bold', 'text-xl');
                icon.textContent = conv.name.charAt(0).toUpperCase();
        
                const content = document.createElement('div');
                content.classList.add('flex-grow');
        
                const header = document.createElement('div');
                header.classList.add('flex', 'justify-between', 'items-center', 'mb-1');
        
                const name = document.createElement('h3');
                name.classList.add('font-semibold', 'text-lg', 'text-white');
                name.textContent = conv.name;
        
                const time = document.createElement('span');
                time.classList.add('text-sm', 'text-white', 'opacity-70');
                time.textContent = conv.time;
        
                const lastMessage = document.createElement('p');
                lastMessage.classList.add('text-white', 'opacity-80', 'text-sm', 'truncate');
                lastMessage.textContent = conv.lastMessage || (conv.isGroup ? 'Nouveau groupe créé' : 'Nouvelle conversation');
        
                const starButton = document.createElement('button');
                starButton.classList.add('text-xl', 'ml-2', 'transition-colors', 'duration-200');
                starButton.innerHTML = starredConversations.has(conv.id) ? '<i class="fas fa-star text-yellow-400"></i>' : '<i class="far fa-star text-white opacity-50"></i>';
                starButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleStarConversation(conv.id);
                });
        
                header.appendChild(name);
                header.appendChild(time);
                content.appendChild(header);
                content.appendChild(lastMessage);
                conversationItem.appendChild(icon);
                conversationItem.appendChild(content);
                conversationItem.appendChild(starButton);
                conversationsList.appendChild(conversationItem);
        
                conversationItem.addEventListener('click', () => {
                    currentChatId = conv.id;
                    currentChatData = conv;
                    renderChatPage(conv);
                    navigateTo('chat');
                });
            });
        }
        
        async function toggleStarConversation(chatId) {
            const isStarred = starredConversations.has(chatId);
            if (isStarred) {
                starredConversations.delete(chatId);
            } else {
                starredConversations.add(chatId);
            }
        
            const conversationToUpdate = window.currentUserData.conversations.find(c => c.id === chatId);
            if (conversationToUpdate) {
                conversationToUpdate.isPriority = !isStarred;
        
                try {
                    const response = await fetch(`${backendUrl}/user/${encodeURIComponent(window.currentUserData.email)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ conversations: window.currentUserData.conversations }),
                    });
                    if (!response.ok) {
                        showMessageBox("Erreur lors de la mise à jour de la conversation.", "error");
                        // Rollback si l'update échoue
                        if (isStarred) {
                            starredConversations.add(chatId);
                        } else {
                            starredConversations.delete(chatId);
                        }
                        conversationToUpdate.isPriority = isStarred;
                    }
                } catch (error) {
                    console.error('Erreur réseau lors de la mise à jour de la conversation:', error);
                    showMessageBox('Erreur réseau. Impossible de mettre à jour la conversation.', 'error');
                    // Rollback si l'update échoue
                    if (isStarred) {
                        starredConversations.add(chatId);
                    } else {
                        starredConversations.delete(chatId);
                    }
                    conversationToUpdate.isPriority = isStarred;
                }
            }
            updateHomeUI();
        }
        
        
        function renderChatPage(chat) {
            chatHeaderName.textContent = chat.name;
            chatMessages.innerHTML = '';
        
            if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach(msg => {
                    appendMessageToChat(msg);
                });
            } else {
                chatMessages.innerHTML = '<p class="text-white text-center opacity-70 mt-4">Commencez la conversation !</p>';
            }
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }
        
        function appendMessageToChat(message) {
            const messageElement = document.createElement('div');
            const isMyMessage = message.sender === window.currentUserData.email;
            messageElement.classList.add('flex', 'mb-3', isMyMessage ? 'justify-end' : 'justify-start');
        
            const messageContent = document.createElement('div');
            messageContent.classList.add(
                'p-3',
                'rounded-xl',
                'max-w-xs',
                isMyMessage ? 'bg-yellow-400 text-purple-900' : 'bg-purple-600 text-white'
            );
        
            const senderName = document.createElement('span');
            senderName.classList.add('font-semibold', 'text-sm', 'block', 'mb-1');
            senderName.textContent = isMyMessage ? 'Moi' : message.sender.split('@')[0]; // Afficher le début de l'email pour les autres
        
            const messageTextContent = document.createElement('p');
            messageTextContent.classList.add('text-base', 'break-words');
            messageTextContent.textContent = message.content;
        
            const messageTime = document.createElement('span');
            messageTime.classList.add('block', 'text-xs', 'mt-1', isMyMessage ? 'text-purple-700' : 'text-white', 'opacity-70', 'text-right');
            messageTime.textContent = message.time;
        
            messageContent.appendChild(senderName);
            messageContent.appendChild(messageTextContent);
            messageContent.appendChild(messageTime);
            messageElement.appendChild(messageContent);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        sendMessageButton.addEventListener('click', async () => {
            const content = chatMessageInput.value.trim();
            if (!content || !currentChatId || !window.currentUserData) {
                return;
            }
        
            try {
                const response = await fetch(`${backendUrl}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversationId: currentChatId,
                        senderEmail: window.currentUserData.email,
                        content: content,
                    }),
                });
                const result = await response.json();
                if (response.ok) {
                    // Mettre à jour localement les données du chat avec le nouveau message
                    const conversation = window.currentUserData.conversations.find(c => c.id === currentChatId);
                    if (conversation) {
                        conversation.messages.push(result.newMessage);
                        conversation.lastMessage = result.newMessage.content;
                        conversation.time = result.newMessage.time;
                    }
                    appendMessageToChat(result.newMessage);
                    chatMessageInput.value = '';
                    // Optionnel: émettre un événement Socket.IO ici si vous l'avez configuré
                    // socket.emit('sendMessage', { conversationId: currentChatId, message: result.newMessage });
                } else {
                    showMessageBox(`Erreur d'envoi de message : ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Erreur réseau lors de l\'envoi du message:', error);
                showMessageBox('Impossible d\'envoyer le message. Erreur de connexion au serveur.', 'error');
            }
        });
        
        
        createChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const contactName = chatContactNameInput.value.trim();
            const contactIdentifier = chatContactIdentifierInput.value.trim();
        
            if (!contactName || !contactIdentifier) {
                showMessageBox("Veuillez entrer un nom et un email pour le contact.");
                return;
            }
        
            if (!window.currentUserData || !window.currentUserData.email) {
                showMessageBox("Erreur: Utilisateur non connecté. Veuillez vous reconnecter.", "error");
                navigateTo('auth');
                return;
            }
        
            try {
                const response = await fetch(`${backendUrl}/contacts/add-by-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        adderEmail: window.currentUserData.email,
                        contactEmail: contactIdentifier,
                        contactName: contactName,
                    }),
                });
                const result = await response.json();
                if (response.ok) {
                    showMessageBox(result.message, 'success');
                    await fetch(`${backendUrl}/user/${encodeURIComponent(window.currentUserData.email)}`)
                        .then(res => res.json())
                        .then(userData => {
                            window.currentUserData = userData;
                            starredConversations = new Set(userData.conversations.filter(c => c.isPriority).map(c => c.id));
                            updateHomeUI();
                            navigateTo('home');
                        });
                } else {
                    showMessageBox(`Erreur lors de l'ajout du contact : ${result.error || 'Erreur inconnue'}`, 'error');
                }
            } catch (error) {
                console.error('Network error during contact addition:', error);
                showMessageBox('Impossible d\'ajouter le contact. Erreur de connexion au serveur.', 'error');
            }
            chatContactNameInput.value = '';
            chatContactIdentifierInput.value = '';
        });
        
        
        createGroupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = groupNameInput.value.trim();
            const membersInput = groupMembersInput.value.trim();
            const endDate = groupEndDateInput.value;
        
            if (!groupName || !membersInput || !endDate) {
                showMessageBox("Veuillez remplir tous les champs pour créer un groupe.");
                return;
            }
        
            if (!window.currentUserData || !window.currentUserData.email) {
                showMessageBox("Erreur: Utilisateur non connecté. Veuillez vous reconnecter.", "error");
                navigateTo('auth');
                return;
            }
        
            const members = membersInput.split(',').map(email => email.trim()).filter(email => email !== '');
        
            // Assurez-vous que l'utilisateur créateur est inclus dans les membres du groupe
            if (!members.includes(window.currentUserData.email)) {
                members.unshift(window.currentUserData.email);
            }
        
            try {
                const response = await fetch(`${backendUrl}/groups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: window.currentUserData.email,
                        name: groupName,
                        members: members,
                        endDate: endDate,
                    }),
                });
                const result = await response.json();
                if (response.ok) {
                    showMessageBox(result.message, 'success');
                    // Mettre à jour les conversations de l'utilisateur après la création du groupe
                    // Il est préférable de refetch les données utilisateur complètes pour s'assurer de la cohérence
                    await fetch(`${backendUrl}/user/${encodeURIComponent(window.currentUserData.email)}`)
                        .then(res => res.json())
                        .then(userData => {
                            window.currentUserData = userData;
                            starredConversations = new Set(userData.conversations.filter(c => c.isPriority).map(c => c.id));
                            updateHomeUI();
                            navigateTo('home');
                        });
                } else {
                    showMessageBox(`Erreur lors de la création du groupe : ${result.error || 'Erreur inconnue'}`, 'error');
                }
            } catch (error) {
                console.error('Erreur réseau lors de la création du groupe:', error);
                showMessageBox('Impossible de créer le groupe. Erreur de connexion au serveur.', 'error');
            }
            groupNameInput.value = '';
            groupMembersInput.value = '';
            groupEndDateInput.value = '';
        });
        
        
        chatInfoButton.addEventListener('click', () => {
            if (currentChatData) {
                chatInfoName.textContent = currentChatData.name;
                chatInfoIsGroup.textContent = currentChatData.isGroup ? 'Oui' : 'Non';
        
                if (currentChatData.isGroup) {
                    chatInfoParticipants.parentElement.classList.remove('hidden');
                    chatInfoEndDate.parentElement.classList.remove('hidden');
                    chatInfoTimer.parentElement.classList.remove('hidden');
        
                    chatInfoParticipants.innerHTML = '';
                    currentChatData.members.forEach(member => {
                        const li = document.createElement('li');
                        li.textContent = member;
                        chatInfoParticipants.appendChild(li);
                    });
                    chatInfoEndDate.textContent = currentChatData.endDate;
                    chatInfoTimer.textContent = currentChatData.timer; // Assurez-vous que le timer est mis à jour quelque part
                } else {
                    // C'est un chat individuel, `participants` est utilisé pour trouver l'autre partie
                    chatInfoParticipants.parentElement.classList.remove('hidden');
                    const otherParticipant = currentChatData.participants.find(p => p !== window.currentUserData.email);
                    chatInfoParticipants.innerHTML = `<li>${otherParticipant}</li>`;
        
                    chatInfoEndDate.parentElement.classList.add('hidden');
                    chatInfoTimer.parentElement.classList.add('hidden');
                }
                chatInfoModal.classList.remove('hidden');
            }
        });
        
        
        chatInfoCloseButton.addEventListener('click', () => {
            chatInfoModal.classList.add('hidden');
        });

        getStartedButton.addEventListener('click', () => {
            navigateTo('auth');
        });
    </script>
</body>
</html>
